#!/bin/bash

# Definisikan pin GPIO yang digunakan untuk baris dan kolom
ROWS=(17 18 27 22)  # Sesuaikan dengan GPIO BCM yang Anda gunakan
COLS=(23 24 25 4)   # Sesuaikan dengan GPIO BCM yang Anda gunakan

# Pemetaan keypad
KEYS=("1" "2" "3" "A"
      "4" "5" "6" "B"
      "7" "8" "9" "C"
      "*" "0" "#" "D")

# Ekspor semua GPIO dan set arah
setup_gpio() {
    for pin in "${ROWS[@]}" "${COLS[@]}"; do
        echo "$pin" > /sys/class/gpio/export 2>/dev/null
    done

    # Set baris sebagai output dan kolom sebagai input
    for row in "${ROWS[@]}"; do
        echo "out" > /sys/class/gpio/gpio$row/direction
        echo "1" > /sys/class/gpio/gpio$row/value
    done

    for col in "${COLS[@]}"; do
        echo "in" > /sys/class/gpio/gpio$col/direction
        echo "1" > /sys/class/gpio/gpio$col/value
    done
}

# Cleanup GPIO
cleanup_gpio() {
    for pin in "${ROWS[@]}" "${COLS[@]}"; do
        echo "$pin" > /sys/class/gpio/unexport
    done
}

# Baca keypad
read_keypad() {
    for row in "${!ROWS[@]}"; do
        echo "0" > /sys/class/gpio/gpio${ROWS[$row]}/value
        for col in "${!COLS[@]}"; do
            if [ "$(cat /sys/class/gpio/gpio${COLS[$col]}/value)" == "0" ]; then
                echo "Key Pressed: ${KEYS[$((row * 4 + col))]}"
                while [ "$(cat /sys/class/gpio/gpio${COLS[$col]}/value)" == "0" ]; do
                    sleep 0.01
                done
            fi
        done
        echo "1" > /sys/class/gpio/gpio${ROWS[$row]}/value
    done
}

# Setup GPIO
setup_gpio

# Baca keypad secara terus-menerus
while true; do
    read_keypad
    sleep 0.1
done

# Cleanup GPIO saat selesai
trap cleanup_gpio EXIT
